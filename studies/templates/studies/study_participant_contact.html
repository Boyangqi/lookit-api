{% extends 'exp/base.html' %}
{% load bootstrap3 %}
{% load guardian_tags %}
{% load exp_extras %}

{% block head %}
    {{ block.super }}
    <link rel="stylesheet" type="text/css"
          href="https://cdn.datatables.net/v/bs/jszip-2.5.0/dt-1.10.18/b-1.5.6/b-html5-1.5.6/fh-3.1.4/r-2.2.2/rg-1.1.0/sc-2.0.0/sl-1.3.0/datatables.min.css"/>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.10/dist/css/bootstrap-select.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.11/summernote.css" rel="stylesheet">
    <!-- Datatables -->
    <script type="text/javascript"
            src="https://cdn.datatables.net/v/bs/jszip-2.5.0/dt-1.10.18/b-1.5.6/b-html5-1.5.6/fh-3.1.4/r-2.2.2/rg-1.1.0/sc-2.0.0/sl-1.3.0/datatables.min.js"></script>
    <!-- Bootstrap Select -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.10/dist/js/bootstrap-select.min.js"></script>
    <!-- Summernote -->
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/summernote/0.8.11/summernote.js"></script>
{% endblock %}

{% block title %}Contact Participants{% endblock %}

{# this "flash" block is just for notifications. It's defined in base and overridden here. #}
{% block flash %}
    {% if messages %}
        {% for message in messages %}
            {% if message.extra_tags != 'message_sent' %}
                <div id="details" class="alert {{ message.tags }} alert-dismissable">
                    <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
                    {{ message }}
                </div>
            {% endif %}
        {% endfor %}
    {% endif %}
{% endblock %}

{% block content %}
    <div class="container">
        <div class="row">
            <div class="col-xs-12">
                <ol class="breadcrumb">
                    <li><a href="{% url 'exp:study-list' %}">Manage Studies</a></li>
                    <li><a href="{% url 'exp:study-detail' pk=study.id %}"> {{ study.name }}</a></li>
                    <li class="active"> Contact Participants</li>
                </ol>
            </div>
        </div>
        <div class="row">
            <section class="col-lg-6">
                <div class="panel panel-default mt-md">
                    <div class="panel-heading"><h3 class="panel-title">Previous Messages</h3></div>
                    <div class="panel-body">
                        <form class="form-horizontal">
                            <div class="input-group">
                                <label class="input-group-addon" for="full-text-search">Text</label>
                                <input id="full-text-search" type="text" class="form-control"
                                       placeholder="Full Text Search">
                            </div>
                        </form>
                    </div>
                    <div id="previous-messages-list" class="list-group pretty-scroll">
                        {% for message in previous_messages %}
                            <a href="#previous-message-viewer?uuid={{ message.uuid }}"
                               class="list-group-item"
                               data-recipients="{% values_list_as_json message.recipients.all "uuid" %}"
                               data-message-body="{{ message.body }}">
                                <h4 class="col-md-6 list-group-item-heading">{{ message.subject }}</h4>
                                <div class="col-md-6 small">
                                    <section>
                                        <strong>Sender:</strong>
                                        <span>{{ message.sender.nickname }}</span>
                                    </section>
                                    <section>
                                        <strong>Recipients:</strong>
                                        <span>
                                            {% if message.recipients.all|length >= 4 %}
                                                <span>{{ message.recipients.all|length }} Participants</span>
                                            {% else %}
                                                {% for recipient in message.recipients.all %}
                                                    <span>{{ recipient.nickname }}</span>{% if not forloop.last %},
                                                {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                        </span>
                                    </section>
                                </div>
                                <p class="row list-group-item-text">
                                <blockquote class="small message-body">{{ message.body|striptags }}</blockquote>
                                </p>
                            </a>
                        {% endfor %}
                    </div>
                    <div class="panel-footer">
                        <table id="participant-table" class="table table-condensed">
                            <thead>
                            <tr>
                                <th>UUID</th>
                                <th>Full Name</th>
                                <th>Organization</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for person in participants %}
                                <tr>
                                    <td>{{ person.uuid }}</td>
                                    <td>{{ person.get_full_name }}</td>
                                    <td>{{ person.organization.name }}</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <th>UUID</th>
                                    <th>Full Name</th>
                                    <th>Organization</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

            </section>
            <main class="col-lg-6">
                <div id="email-viewport" class="panel panel-default mt-md">
                    <section class="panel-heading"><h3 class="panel-title">Messages</h3></section>
                    <ul id="email-viewer-tabs" class="nav nav-tabs nav-justified">
                        <li class="active" role="presentation">
                            <a data-toggle="tab" aria-controls="email-participants-form"
                               href="#email-participants-form">
                                Compose New
                            </a>
                        </li>
                        <li role="presentation">
                            <a data-toggle="tab" aria-controls="previous-message-viewer"
                               href="#previous-message-viewer">Message Viewer</a>
                        </li>
                    </ul>
                    <section class="tab-content">
                        <form id="email-participants-form" class="tab-pane active"
                              method="post">{% csrf_token %}
                            <section class="form-group">
                                <label class="control-label" for="recipient-selector">Recipients</label>
                                <select id="recipient-selector"
                                        name="recipients"
                                        class="selectpicker form-control"
                                        multiple>
                                    {% for person in participants %}
                                        <option value="{{ person.uuid }}"
                                                data-content="{% include "studies/_recipient_select_content.html" with recipient=person %}">
                                            {{ person.get_full_name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </section>
                            <section class="form-group">
                                <label class="control-label" for="email-subject">Subject</label>
                                <input id="email-subject" name="subject" type="text" class="form-control"/>
                            </section>
                            <section class="form-group">
                                <label class="control-label" for="email-editor">Body</label>
                                <textarea id="email-editor" name="body"></textarea>
                            </section>
                            <section class="form-group">
                                <button type="submit" class="btn btn-primary btn-lg btn-block">
                                    Send Messages to Participants
                                </button>
                            </section>
                        </form>
                        <div id="previous-message-viewer" class="tab-pane pretty-scroll">
                            <h3 id="subject-line-view"></h3>
                            <section class="pretty-scroll" id="message-body-view">
                                {# Contents loaded here #}
                            </section>
                        </div>
                    </section>
                </div>
            </main>
        </div>
    </div>
    {#  TODO: move this out to a javascript file so we can defer it!  #}
    <script type="text/javascript">
        const HIDDEN_UUID_COLUMN = 0;
        const DATATABLE_SETTINGS = {
            select: true,
            // Complicated as hell - please see https://datatables.net/reference/option/dom
            dom:  "<'row'<'col-sm-6'l><'col-sm-6'f>>" + // (l)ength input ctrl, (f)iltering input
                  "<'row'<'col-sm-12'iS>>" +            // (i)nformation summary, (S)elect
                  "<'row'<'col-sm-12'tr>>" +            // (t)able, p(r)ocessing display
                  "<'row'<'col-sm-6'B><'col-sm-6'p>>",   // (B)uttons, (p)agination
            buttons: [ // For custom buttons, see - https://datatables.net/extensions/buttons/custom
                {
                    extend: 'copy',
                    text: 'Copy to Clipboard',
                },
                {
                    extend: 'excel',
                    text: 'Excel',
                },
                {
                    extend: 'csv',
                    text: 'CSV',
                },
            ],
            fixedHeader: true,
            columnDefs: [
                {visible: false, searchable: false, targets: HIDDEN_UUID_COLUMN}
            ],
        };

        const EMAIL_EDITOR_SETTINGS = {
            codeviewFilter: false, // Prevent XSS
            codeviewIframeFilter: true, // Prevent XSS
            placeholder: 'Write email contents here.',
            tabsize: 2,
            height: 150,
        };

        const RECIPIENT_SELECTOR_SETTINGS = {
            actionsBox: true,
            sanitize: true,
            // style: 'btn-small',
            styleBase: 'btn',
            width: "100%",
            liveSearch: true,
            selectedTextFormat: "count > 3",
            title: "Search and add recipients",
            header: "Use mouse and/or arrow keys for navigation; return key to select participants",
        };

        const VIEW_INIT_PARAMS = new URLSearchParams(window.location.search);

        // jqElements
        const $participantTable = $('#participant-table'),
            $messageParticipantsForm = $('#email-participants-form'),
            $subjectLine = $('#email-subject'),
            $recipientSelector = $('#recipient-selector'),
            $emailEditor = $('#email-editor'),
            $messageList = $('#previous-messages-list'),
            $messageListItems = $('#previous-messages-list a'),
            $messageSearch = $('#full-text-search'),
            $composeTab = $('#email-viewer-tabs a[href=#email-participants-form]'),
            $viewerTab = $('#email-viewer-tabs a[href=#previous-message-viewer]'),
            /* --- Single Message Viewer --- */
            $messageViewer = $('#previous-message-viewer'),
            $subjectLineView = $messageViewer.find('#subject-line-view'),
            $messageBodyView = $messageViewer.find('#message-body-view');

        /**
         * Main function.
         */
        function initializeView() {
            // Set up Datatable.
            $participantTable.DataTable(DATATABLE_SETTINGS)
                .on("select deselect", handleParticipantTableSelection)
                .columns().every(initializeColumnFilters);

            // Set up email container
            $emailEditor.summernote(EMAIL_EDITOR_SETTINGS);

            // Add event handlers.
            $recipientSelector.selectpicker(RECIPIENT_SELECTOR_SETTINGS)
                .on('changed.bs.select', participantSelectionCallback);

            $messageSearch.on("keyup", handleMessageSearch);

            $messageList.on("click", "a", handleMessageSelection);

            $messageParticipantsForm.on("submit", handleMessageFormSubmit);
        }

        function initializeColumnFilters() {
            let column = this;
            let select = $('<select class="form-control"><option value=""></option></select>')
                .appendTo($(column.footer()).empty())
                .on('change', function() {
                    let val = $.fn.dataTable.util.escapeRegex(
                        $(this).val()
                    );

                    column
                        .search( val ? '^' + val + '$' : '', true, false )
                        .draw();
                });

            // Create a new option for each piece of data.
            column.data().unique().sort().each(function(datum) {
                select.append('<option value="' + datum + '">'+ datum + '</option>')
            });
        }

        /**
         * Filter based on currently selected emails from participant table.
         *
         * @param $jqEvent The jquery Event object.
         * @param datatablesApi the Datatables API (see: https://datatables.net/reference/api/).
         * @param itemType This will pretty much always be a column or row.
         * @param indices The indices of the selection within the table.
         */
        function handleParticipantTableSelection($jqEvent, datatablesApi, itemType, indices) {

            let selectedEmails = new Set(datatablesApi.cells(indices, HIDDEN_UUID_COLUMN).data().toArray());

            $messageListItems.filter(function (index, li) {
                let $anchorTag = $(li);
                let recipientList = $anchorTag.data('recipients');
                $anchorTag.toggle(recipientList.some(person => selectedEmails.has(person)));
            });
        }


        function handleMessageSearch() {
            let searchValue = this.value.toLowerCase();
            $messageListItems.filter((index, li) => $(li).toggle(li.innerText.toLowerCase().indexOf(searchValue) > -1));
        }

        function handleMessageSelection() {
            let $message = $(this),
                messageData = $message.data();
            $messageListItems.not($message).removeClass('active');
            $message.toggleClass('active');
            if ($message.hasClass('active')) {
                $viewerTab.tab('show');
                $subjectLineView.html($message.find('h4').text());
                $messageBodyView.html(messageData['messageBody']);
            } else {
                $composeTab.tab('show');
                $subjectLineView.text('No message selected.');
                $messageBodyView.text('Please select a message on the left sidebar.');
            }
        }

        function handleMessageFormSubmit($jqEvent) {
            if (!messageFormIsValid_()) {
                $jqEvent.preventDefault();
            }
        }

        /**
         * Validate the message form. No plugins because the validation we want to do is rather simple.
         *
         * XXX: Has side effects in the view!
         *
         * @return boolean
         */
        function messageFormIsValid_() {
            let subject = $subjectLine.val(),
                body = $emailEditor.val(),
                recipients = $recipientSelector.val(),
                isValid = true;

            if (!subject) {
                isValid = false;
                $subjectLine.closest('.form-group').addClass('has-error');
            }
            if (!body) {
                isValid = false;
                $emailEditor.closest('.form-group').addClass('has-error');
            }
            if (!recipients) {
                isValid = false;
                $recipientSelector.closest('.form-group').addClass('has-error');
            }

            return isValid;
        }

        /**
         * Do things when we select a participant from the Bootstrap-select component.
         *
         * @param $jqEvent
         * @param clickedIndex
         * @param isSelected
         * @param previousValue
         */
        function participantSelectionCallback($jqEvent, clickedIndex, isSelected, previousValue) {
            console.log($jqEvent, clickedIndex, isSelected, previousValue);
            if (isSelected) {
                $(this).closest('.form-group').removeClass('has-error');
            }
        }

        // Run initializations.
        initializeView();
    </script>
{% endblock %}