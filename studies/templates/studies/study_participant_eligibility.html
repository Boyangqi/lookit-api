{% extends 'exp/base.html' %}
{% load bootstrap3 %}
{% load exp_extras %}

{% block title %}Participant Eligibility | {{ eligible_participant_query_model.study }} {% endblock %}
{% block head %}
    {{ block.super }}
    {# NoUI Slider #}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.0.2/nouislider.min.js"
            integrity="sha256-VG+4f1Hm2q4e+DTEOaiZKlWjJm5W4yqnXNvKkWBYA20=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.0.2/nouislider.min.css"
          integrity="sha256-6pa9Ln4B/FyHlxOYaXuwpET9xH0e21iX0SPLg9P5Ro0=" crossorigin="anonymous"/>

    {# Bootstrap Toggle -- keeping here in case it is needed later #}
    <link href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" rel="stylesheet">
    <script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>

    {# Moment #}
    <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>

{% endblock %}

{% block flash %}
    {% bootstrap_messages %}
    {% if form.non_field_errors %}
        <div class="alert alert-danger" role="alert">
            {{ form.non_field_errors }}
        </div>
    {% endif %}
{% endblock %}

{% block content %}
    <div class="container mb-lg">
        <div class="row">
            <div class="col-xs-12">
                <ol class="breadcrumb">
                    <li><a href="{% url 'exp:study-list' %}">Manage Studies</a></li>
                    <li>
                        <a href="{% url 'exp:study-detail' pk=eligible_participant_query_model.study.id %}">
                            {{ eligible_participant_query_model.study.name }}
                        </a>
                    </li>
                    <li class="active">Participant Eligibility</li>
                </ol>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-10 col-lg-offset-1">
                <div class="panel panel-default mt-xl">
                    <div class="panel-heading">
                        <h1 class="panel-title">Edit Participant Eligibility</h1>
                    </div>
                    <div class="panel-body">
                        <h3>Current Eligibility Criteria</h3>
                        <div class="well well-sm">
                            <dl class="dl-horizontal">
                                <dt>Gestational Age</dt>
                                <dd id="gestational-age-summary">
                                    Born between <em>{{ object.get_gestational_age_start_display }}</em>
                                    and <em>{{ object.get_gestational_age_end_display }}</em>
                                    ({% if not object.gestational_age_include_na %}don't {% endif %}include N/A)
                                </dd>
                                <dt>Age Range</dt>
                                <dd id="age-range-summary">
                                    Between <em>{{ object.age_range_start_years }}</em> years,
                                    <em>{{ object.age_range_start_months }}</em> months,
                                    <em>{{ object.age_range_start_days }}</em> days old
                                    and <em>{{ object.age_range_end_years }}</em> years,
                                    <em>{{ object.age_range_end_months }}</em> months, and
                                    <em>{{ object.age_range_end_days}}</em> days old
                                </dd>
                                <dt>Gender Specification</dt>
                                <dd id="gender-specification-summary">
                                    <em>{{ object.get_gender_specification_display|default_if_none:"Doesn't matter" }}</em>
                                </dd>
                                <dt>Characteristics</dt>
                                <dd id="characteristics-summary">
                                    {% if object.require_conditions.mask == 0 %}
                                        <p>No required characteristics/conditions.</p>
                                    {% else %}
                                        Require:
                                        <ul>
                                            {% for bit in object.require_conditions %}
                                                {% bit_is_set object.require_conditions forloop.counter0 as show_bit %}
                                                {% if show_bit %}
                                                    <li>{% get_bit_label object.require_conditions forloop.counter0 %}</li>
                                                {% endif %}
                                            {% endfor %}
                                        </ul>
                                    {% endif %}
                                    {% if object.exclude_conditions.mask == 0 %}
                                        <p>No excluded characteristics/conditions.</p>
                                    {% else %}
                                        Exclude:
                                        <ul>
                                            {% for bit in object.exclude_conditions %}
                                                {% bit_is_set object.exclude_conditions forloop.counter0 as show_bit %}
                                                {% if show_bit %}
                                                    <li>{% get_bit_label object.exclude_conditions forloop.counter0 %}</li>
                                                {% endif %}
                                            {% endfor %}
                                        </ul>
                                    {% endif %}
                                </dd>
                                <dt>Languages Spoken</dt>
                                <dd id="languages-spoken-summary">
                                    {% if object.require_languages.mask == 0 %}
                                        <p>No required languages.</p>
                                    {% else %}
                                        Require:
                                        <ul>
                                            {% for bit in object.require_languages %}
                                                {% bit_is_set object.require_languages forloop.counter0 as show_bit %}
                                                {% if show_bit %}
                                                    <li>{% get_bit_label object.require_languages forloop.counter0 %}</li>
                                                {% endif %}
                                            {% endfor %}
                                        </ul>
                                    {% endif %}
                                    {% if object.exclude_languages.mask == 0 %}
                                        <p>No excluded languages.</p>
                                    {% else %}
                                        Exclude:
                                        <ul>
                                            {% for bit in object.exclude_languages %}
                                                {% bit_is_set object.exclude_languages forloop.counter0 as show_bit %}
                                                {% if show_bit %}
                                                    <li>{% get_bit_label object.exclude_languages forloop.counter0 %}</li>
                                                {% endif %}
                                            {% endfor %}
                                        </ul>
                                    {% endif %}
                                </dd>
                            </dl>
                        </div>
                        <h3>Define New Eligibility Criteria</h3>
                        <form method="POST" id="edit-participant-eligibility" class="well well-sm clearfix">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-primary btn-lg btn-block">Submit Proposed Changes</button>
                            <section class="form-group col-md-5">
                                <h4>
                                    Gestational Age
                                </h4>
                                <div id="gestational-age-range-specifier" class="range-specifier"></div>
                                <label for="gestational-age-include-na">
                                    <input id="gestational-age-include-na"
                                           name="gestational_age_include_na"
                                           type="checkbox"
                                           data-toggle="toggle"
                                           data-on="Include N/A"
                                           data-off="Exclude N/A"
                                           data-onstyle="success"
                                           data-offstyle="danger"
                                           data-size="mini"
                                           data-width="120"
                                           checked>
                                </label>
                            </section>
                            <section class="form-group col-md-push-1 col-md-6">{# Age Range -- slider #}
                                <h4>Age Range</h4>
                                <div id="age-range-specifier" class="range-specifier"></div>
                                <table id="age-range-details" class="table small">
                                    <tr>
                                        <td><label for="total-days">Total Range:</label></td>
                                        <td><input id="total-days" class="form-control" type="number" min=0 max=7300 step=1>
                                            Days in total
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><label for="age-range-start">Current latest birthday:</label></td>
                                        <td><input id="age-range-start" class="form-control" type="date"></td>
                                    </tr>
                                    <tr>
                                        <td><label for="age-range-end">Current earliest birthday:</label></td>
                                        <td><input id="age-range-end" class="form-control" type="date"></td>
                                    </tr>
                                </table>
                            </section>
                            <section class="form-group col-md-12">{# Gender - quad button group #}
                                <h4>Gender Specification</h4>
                                <div class="debug-django-choices">
                                    {% for choice in object.gender_specification.choices %}
                                        {{ choice }}
                                    {% endfor %}
                                </div>
                                {% comment %}
                                The values below - na, 1, 2, 3, -  are defined in studies/fields.py, copied here for
                                clarity:

                                GENDER_OPTIONS = (
                                    (0, "na", _("Not answered")),
                                    (1, "o", _("Other")),
                                    (2, "m", _("Male")),
                                    (3, "f", _("Female")),
                                )
                                {% endcomment %}
                                <div id="gender-selector" class="btn-group btn-group-justified" data-toggle="buttons">
                                    <label class="btn btn-default {% if object.gender_specification == None %}active{% endif %}" for="does-not-matter">
                                        <input id="does-not-matter"
                                               name="gender_specification"
                                               type="radio"
                                               autocomplete="off"
                                               value=""
                                               {% if object.gender_specification == None %}checked{% endif %}>
                                        Doesn't Matter
                                    </label>
                                    <label class="btn btn-warning {% if object.gender_specification == 0 %}active{% endif %}" for="unspecified-only">
                                        <input id="unspecified-only"
                                               name="gender_specification"
                                               type="radio"
                                               autocomplete="off"
                                               value="0"
                                               {% if object.gender_specification == 0 %}checked{% endif %}>
                                        Unspecified Only
                                    </label>
                                    <label class="btn btn-primary {% if object.gender_specification == 1 %}active{% endif %}" for="other-only">
                                        <input id="other-only"
                                               name="gender_specification"
                                               type="radio"
                                               autocomplete="off"
                                               value="1"
                                               {% if object.gender_specification == 1 %}checked{% endif %}>
                                        Other Only
                                    </label>
                                    <label class="btn btn-primary {% if object.gender_specification == 2 %}active{% endif %}" for="male-only">
                                        <input id="male-only"
                                               name="gender_specification"
                                               type="radio"
                                               autocomplete="off"
                                               value="2"
                                               {% if object.gender_specification == 2 %}checked{% endif %}>
                                        Male Only
                                    </label>
                                    <label class="btn btn-primary {% if object.gender_specification == 3 %}active{% endif %}" for="female-only">
                                        <input id="female-only"
                                               name="gender_specification"
                                               type="radio"
                                               autocomplete="off"
                                               value="3"
                                               {% if object.gender_specification == 3 %}checked{% endif %}>
                                        Female Only
                                    </label>
                                </div>
                            </section>

                            {# Characteristics - custom set of button groups? #}
                            <section class="form-group col-md-6">
                                <h4>
                                    Characteristics
                                    <div id="control-all-conditions"
                                         class="btn-group btn-group-xs pull-right"
                                         role="group"
                                         aria-label="Toggle All Characteristics/Conditions">
                                        <button type="button" class="btn btn-danger">Exclude All</button>
                                        <button type="button" class="btn btn-default">Reset</button>
                                        <button type="button" class="btn btn-success">Require All</button>
                                    </div>
                                </h4>
                                <table class="table">
                                    <thead>
                                    <tr>
                                        <th colspan=2>
                                        </th>
                                    </tr>
                                    </thead>
                                    <tbody id="characteristics-switch-table">
                                    {%  comment %}
                                        Not optimal to use the form fields as a proxy this way.
                                        Maybe we can directly reference the fields in the context object?
                                    {% endcomment %}
                                    {% for option in form.fields.require_conditions.choices %}
                                        {% bit_is_set object.require_conditions forloop.counter0 as required_bit %}
                                        {% bit_is_set object.exclude_conditions forloop.counter0 as excluded_bit %}
                                        <tr>
                                            <td>
                                                <div class="btn-group btn-group-xs" data-toggle="buttons">
                                                    <label class="btn btn-danger {% if excluded_bit %}active{% endif %}" for="exclude-{{ option.0 }}">
                                                        <input id="exclude-{{ option.0 }}"
                                                               name="exclude_conditions"
                                                               type="checkbox"
                                                               autocomplete="off"
                                                               value="{{ option.0 }}"
                                                               {% if excluded_bit %}checked{% endif %}>
                                                        Exclude
                                                    </label>
                                                    <label class="btn btn-default {% if not required_bit and not excluded_bit %}active{% endif %}"
                                                           for="unspecified-{{ option.0 }}">
                                                        <input id="unspecified-{{ option.0 }}"
                                                               type="checkbox"
                                                               autocomplete="off"
                                                               {% if not required_bit and not excluded_bit %}checked{% endif %}>
                                                        N/A
                                                    </label>
                                                    <label class="btn btn-success {% if required_bit %}active{% endif %}"
                                                           for="require-{{ option.0 }}">
                                                        <input id="require-{{ option.0 }}"
                                                               name="require_conditions"
                                                               type="checkbox"
                                                               value="{{ option.0 }}"
                                                               autocomplete="off"
                                                               {% if required_bit %}checked{% endif %}>
                                                        Require
                                                    </label>
                                                </div>
                                            </td>
                                            <td class="small">{{ option.1 }}</td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </section>

                            {# Languages Spoken - custom set of button groups? #}
                            <section class="form-group col-md-6">
                                <h4>
                                    Languages Spoken
                                    <div id="control-all-languages"
                                         class="btn-group btn-group-xs pull-right"
                                         role="group"
                                         aria-label="Toggle All Languages">
                                        <button type="button" class="btn btn-danger">Exclude All</button>
                                        <button type="button" class="btn btn-default">Reset</button>
                                        <button type="button" class="btn btn-success">Require All</button>
                                    </div>
                                </h4>
                                <table class="table">
                                    <thead>
                                    <tr>
                                        <th colspan=2>

                                        </th>
                                    </tr>
                                    </thead>
                                    <tbody id="languages-switch-table">
                                    {% for option in form.fields.require_languages.choices %}
                                        {% bit_is_set object.require_languages forloop.counter0 as required_bit %}
                                        {% bit_is_set object.exclude_languages forloop.counter0 as excluded_bit %}
                                        <tr>
                                            <td>
                                                <div class="btn-group btn-group-xs" data-toggle="buttons">
                                                    <label class="btn btn-danger {% if excluded_bit %}active{% endif %}" for="exclude-{{ option.0 }}">
                                                        <input id="exclude-{{ option.0 }}"
                                                               name="exclude_languages"
                                                               type="checkbox"
                                                               value="{{ option.0 }}"
                                                               autocomplete="off"
                                                               {% if excluded_bit %}checked{% endif %}>
                                                        Exclude
                                                    </label>
                                                    <label class="btn btn-default {% if not required_bit and not excluded_bit %}active{% endif %}"
                                                           for="unspecified-{{ option.0 }}">
                                                        <input id="unspecified-{{ option.0 }}"
                                                               type="radio"
                                                               autocomplete="off"
                                                               {% if not required_bit and not excluded_bit %}checked{% endif %}>
                                                        N/A
                                                    </label>
                                                    <label class="btn btn-success {% if required_bit %}active{% endif %}" for="require-{{ option.0 }}">
                                                        <input id="require-{{ option.0 }}"
                                                               name="require_languages"
                                                               type="checkbox"
                                                               value="{{ option.0 }}"
                                                               autocomplete="off"
                                                               {% if required_bit %}checked{% endif %}>
                                                        Require
                                                    </label>
                                                </div>
                                            </td>
                                            <td class="small">{{ option.1 }}</td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </section>
                            {# Hidden inputs #}
                            <input id="gestational-age-start"
                                   name="gestational_age_start"
                                   type="hidden"
                                   value="{{ object.gestational_age_start }}">
                            <input id="gestational-age-end"
                                   name="gestational_age_end"
                                   type="hidden"
                                   value="{{ object.gestational_age_end }}">
                            <input id="age-range-start-years"
                                   name="age_range_start_years"
                                   type="hidden"
                                   value="{{ object.age_range_start_years }}">
                            <input id="age-range-start-months"
                                   name="age_range_start_months"
                                   type="hidden"
                                   value="{{ object.age_range_start_months }}">
                            <input id="age-range-start-days"
                                   name="age_range_start_days"
                                   type="hidden"
                                   value="{{ object.age_range_start_days }}">
                            <input id="age-range-end-years"
                                   name="age_range_end_years"
                                   type="hidden"
                                   value="{{ object.age_range_end_years }}">
                            <input id="age-range-end-months"
                                   name="age_range_end_months"
                                   type="hidden"
                                   value="{{ object.age_range_end_months }}">
                            <input id="age-range-end-days"
                                   name="age_range_end_days"
                                   type="hidden"
                                   value="{{ object.age_range_end_days }}">
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {#  TODO: Once we have a static asset pipeline, move this out to a javascript file so we can defer it. #}
    <script type="text/javascript">
        /*----------------
         * Constants
         --------------- */
        const DATE_INPUT_MOMENT_FORMAT = 'YYYY-MM-DD',
              MOMENT_OF_PAGE_LOAD      = moment(),
              TWENTY_YEARS_AGO         = moment().subtract(20, 'year');

        /*----------------
         * Element handles.
         ---------------- */
        // Regular DOM
        const participantEligibilityForm   = document.getElementById('edit-participant-eligibility'),
              ageRangeSpecifier            = document.getElementById('age-range-specifier'),
              gestationalAgeRangeSpecifier = document.getElementById('gestational-age-range-specifier'),
              totalDaysInput               = document.getElementById('total-days'),
              ageRangeStartInput           = document.getElementById('age-range-start'),
              ageRangeEndInput             = document.getElementById('age-range-end'),
              characteristicSwitches       = document.getElementById('characteristics-switch-table'),
              languageSwitches             = document.getElementById('languages-switch-table'),
              gestationalAgeStartInput     = document.getElementById('gestational-age-start'),
              gestationalAgeEndInput       = document.getElementById('gestational-age-end'),
              ageRangeStartYearsInput      = document.getElementById('age-range-start-years'),
              ageRangeStartMonthsInput     = document.getElementById('age-range-start-months'),
              ageRangeStartDaysInput       = document.getElementById('age-range-start-days'),
              ageRangeEndYearsInput        = document.getElementById('age-range-end-years'),
              ageRangeEndMonthsInput       = document.getElementById('age-range-end-months'),
              ageRangeEndDaysInput         = document.getElementById('age-range-end-days');


        /* ----------------
         * Options objects.
         ---------------- */
        const EX_UTERO_AGE_VALUE_FORMATTER = {
            to(floatNumber) {
                let days = Math.round(floatNumber),
                    duration = moment.duration(days, 'days');
                return `<span class="small">${duration.years()} years,<br />
                        ${duration.months()} months, <br />
                        ${duration.days()} days</span>`;
            },
        };

        const AGE_RANGE_SLIDER_OPTIONS = {
            start: [365 * 4, 365 * 11],  // 4 to 11 years old.
            step: 1,
            behaviour: 'drag',
            connect: true,
            tooltips: [EX_UTERO_AGE_VALUE_FORMATTER, EX_UTERO_AGE_VALUE_FORMATTER],
            range: {
                min: 0,
                max: MOMENT_OF_PAGE_LOAD.diff(TWENTY_YEARS_AGO, 'days'),  // Account for leap years, etc.
            }
        };

        const GESTATIONAL_AGE_STRING_TO_ENUM_INT = {
            "Under 24 weeks": 0,
            "24 weeks": 1,
            "25 weeks": 2,
            "26 weeks": 3,
            "27 weeks": 4,
            "28 weeks": 5,
            "29 weeks": 6,
            "30 weeks": 7,
            "31 weeks": 8,
            "32 weeks": 9,
            "33 weeks": 10,
            "34 weeks": 11,
            "35 weeks": 12,
            "36 weeks": 13,
            "37 weeks": 14,
            "38 weeks": 15,
            "39 weeks": 16,
            "40 or more weeks": 17,
        };

        const GESTATIONAL_AGE_ENUM_INT_TO_STRING = invertObject(GESTATIONAL_AGE_STRING_TO_ENUM_INT);

        const GESTATIONAL_AGE_VALUE_FORMATTER = {
            to: numericValue => GESTATIONAL_AGE_ENUM_INT_TO_STRING[Math.round(numericValue)],
            // 'from' the formatted value.
            // Receives a string, should return a number.
            from: stringValue => GESTATIONAL_AGE_STRING_TO_ENUM_INT[stringValue],
        };

        // Regular weeks, easier
        const GESTATIONAL_AGE_RANGE_SLIDER_OPTIONS = {
            start: [12, 17],
            behaviour: 'drag',
            step: 1,
            connect: true,
            range: {
                "min": [0],
                "max": [17],
            },
            orientation: 'vertical',
            direction: 'rtl',
            tooltips: [GESTATIONAL_AGE_VALUE_FORMATTER, GESTATIONAL_AGE_VALUE_FORMATTER],
            pips: {
                mode: 'values',
                density: 1,
                stepped: true,
                values: [0, 12, 17],
                format: GESTATIONAL_AGE_VALUE_FORMATTER
            },
        };

        /* -----------------
         * Helper functions.
         ----------------- */
        function invertObject(json) {
            let ret = {};
            for (let key in json) {
                ret[json[key]] = key;
            }
            return ret;
        }


        function saveAgeRangeSliderStatesInHiddenFormInputs() {
            let [ageRangeStartInDays, ageRangeEndInDays] = ageRangeSpecifier.noUiSlider.get().map(d => parseInt(d));
            let [gestationalAgeStart, gestationalAgeEnd] = gestationalAgeRangeSpecifier.noUiSlider.get();

            gestationalAgeStartInput.value = parseInt(gestationalAgeStart);
            gestationalAgeEndInput.value   = parseInt(gestationalAgeEnd);

            let ageRangeStartMoment = moment.duration(ageRangeStartInDays, 'days'),
                ageRangeEndMoment   = moment.duration(ageRangeEndInDays, 'days');

            ageRangeStartYearsInput.value  = ageRangeStartMoment.years();
            ageRangeStartMonthsInput.value = ageRangeStartMoment.months();
            ageRangeStartDaysInput.value   = ageRangeStartMoment.days();

            ageRangeEndYearsInput.value    = ageRangeEndMoment.years();
            ageRangeEndMonthsInput.value   = ageRangeEndMoment.months();
            ageRangeEndDaysInput.value     = ageRangeEndMoment.days();
        }


        /* ------------------------
         * Event Handler functions.
         ------------------------ */

        // This is a factory function to generate knob handlers.
        function createBirthdayBoundsInputHandler(handleIndex, inputElement) {
            /**
             * Change the NoUISlider to match what's on the inputs - i.e. calculate how many days ago the given
             * date was.
             */
            return () => {
                let givenDate   = moment(new Date(inputElement.value)),
                    deltaInDays = moment.duration(MOMENT_OF_PAGE_LOAD.diff(givenDate)).asDays();

                ageRangeSpecifier.noUiSlider.setHandle(handleIndex, Math.round(deltaInDays));
            }
        }


        function synchronizeBirthdayInputsWithSlider(values, handleIndex) {
            let [start, end] = values,
                startDays    = parseInt(start),
                endDays      = parseInt(end);

            totalDaysInput.value = Math.round(end) - Math.round(start);

            switch (handleIndex) {
                case 0:     // start handle
                    ageRangeStartInput.value = moment()
                        .subtract(startDays, 'days')
                        .format(DATE_INPUT_MOMENT_FORMAT);
                    break;
                case 1:     // end handle
                    ageRangeEndInput.value = moment()
                        .subtract(endDays, 'days')
                        .format(DATE_INPUT_MOMENT_FORMAT);
                    break;
                default:
                    break;  // This should never happen.
            }
        }

        function synchronizeSliderWithDayRangeInputs() {
            let newDayRange = Math.floor(this.value);
            console.log('inside day range inputs handler');

            // Was not my decision to return integers as strings...
            let [startString, endString] = ageRangeSpecifier.noUiSlider.get(),
                currentStart             = parseInt(startString),
                currentEnd               = parseInt(endString);

            ageRangeSpecifier.noUiSlider.setHandle(1 /* end slider */, currentStart + newDayRange);
        }

        /**
         * Add requisite data to form from the rest of the fields.
         */
        function onFormSubmit(event) {
            let form = this;

            event.preventDefault();

            saveAgeRangeSliderStatesInHiddenFormInputs();

            form.submit();
        }

        /**
         * This function exists to allow type=checkbox inputs across characteristic and language switches so that we can
         * use a singular name label for bitfield inputs (e.g. "include_languages") to gather all the
         * language/characteristic choices into a single list for sensible FormData structure, while enforcing
         * radio button-like behavior within the individual switch (i.e., don't allow the user to both include and
         * exclude a given language/characteristic).
         */
        function uncheckSiblingBitfields(event) {

            let target = event.target;

            if (target.tagName === 'LABEL') { // Manual event delegation
                let inputs = target.parentElement.querySelectorAll('input');

                inputs.forEach(input => { // label active class, input checked
                    if (input.parentNode === target) {
                        input.checked = true;
                        // It appears that bootstrap adds the active class based on the checkbox state, so no need to
                        // manually modify.
                    } else { // label inactive class, input unchecked
                        input.checked = false;
                        input.parentElement.classList.remove('active');
                    }
                });
            }
        }


        /* ------------------------
         * Initialization procedures.
         ------------------------ */
        function loadInitialState(event) {

        }

        function initializeComponents() {
            noUiSlider.create(
                ageRangeSpecifier,
                AGE_RANGE_SLIDER_OPTIONS
            );

            ageRangeSpecifier.noUiSlider.on('update', synchronizeBirthdayInputsWithSlider);

            noUiSlider.create(
                gestationalAgeRangeSpecifier,
                GESTATIONAL_AGE_RANGE_SLIDER_OPTIONS
            );

            // also use steps api to have inputs control sliders
            // https://refreshless.com/nouislider/examples/#section-steps-api

            [ageRangeStartInput, ageRangeEndInput].forEach((inputElement, handleIndex) => {
                inputElement.addEventListener('change', createBirthdayBoundsInputHandler(handleIndex, inputElement));
            });

            totalDaysInput.addEventListener('change', synchronizeSliderWithDayRangeInputs);

            characteristicSwitches.addEventListener('click', uncheckSiblingBitfields);

            languageSwitches.addEventListener('click', uncheckSiblingBitfields);

            participantEligibilityForm.addEventListener('submit', onFormSubmit);
        }

        function initializeView() {
            initializeComponents();
        }

        initializeView();
    </script>
{% endblock %}
