{% extends 'exp/base.html' %}
{% load bootstrap3 %}
{% load exp_extras %}

{% block title %}Responses | {{ study.name }}{% endblock %}

{% block head %}
    {{ block.super }}
    <script type="application/json" id="response-video-map">
        {{ response_video_map | safe }}
    </script>
    <script type="application/javascript">
        const RESET = "reset";
        const CONSENT_APPROVAL = "accepted";
        const CONSENT_REJECTION = "rejected";
        const RESPONSE_VIDEO_MAP = JSON.parse(document.querySelector("#response-video-map").innerText);

        $(document).ready(function () {
            /*
             Initialize important elements.
             */
            const $videoElement = $("#video-under-consideration"),
                  $videoSource = $videoElement.find("source"),
                  $videoManager = $("#video-manager"),
                  $videoPreviousButton = $videoManager.find("#nav-video-previous"),
                  $videoNextButton = $videoManager.find("#nav-video-next"),
                  $pendingJudgementList = $("#responses-pending-ruling"),
                  $consentRulingForm = $("#consent-ruling-form"),
                  $approvalsCountBadge = $consentRulingForm.find("#approvals-count"),
                  $rejectionsCountBadge = $consentRulingForm.find("#rejections-count");

            /*
             Helpers.
             */
            function handleRulingActions($button, $responseListItem, responseData) {
                let responseId = responseData["id"],
                    responseRulingHiddenInputId = "consent-ruling-" + responseId,
                    hiddenInputAttrs = {id: responseRulingHiddenInputId, type: "hidden"},
                    $hiddenInput = $consentRulingForm.find("#" + responseRulingHiddenInputId);

                // First Manage UI signaling
                switch ($button.val()) {
                    case RESET:
                        $responseListItem.removeClass("list-group-item-danger list-group-item-success");
                        $hiddenInput.remove();
                        return;  // early exit after killing the element.
                    case CONSENT_APPROVAL:
                        $responseListItem.removeClass("list-group-item-danger");
                        $responseListItem.addClass("list-group-item-success");
                        hiddenInputAttrs["name"] = CONSENT_APPROVAL;
                        break;
                    case CONSENT_REJECTION:
                        $responseListItem.removeClass("list-group-item-success");
                        $responseListItem.addClass("list-group-item-danger");
                        hiddenInputAttrs["name"] = CONSENT_REJECTION;
                        break;
                }

                if ($hiddenInput.length) {
                    $hiddenInput.attr("name", hiddenInputAttrs["name"]);
                } else {  // If it's not there, create a new one.
                    hiddenInputAttrs["value"] = responseId;
                    $consentRulingForm.append($("<input/>", hiddenInputAttrs));
                }
            }

            var currentlyConsideredVideos, // Lazily initialized closure to maintain video list.
                currentVideoListIndex, // index should correspond to both lists here!
                numberedVideoButtons;

            function updateVideoContainer($selectedResponseItem, responseId) {
                // 1) Clear the current container
                $videoPreviousButton.nextUntil($videoNextButton).remove();

                currentlyConsideredVideos = RESPONSE_VIDEO_MAP[responseId];
                currentVideoListIndex = 0;

                numberedVideoButtons = []; // Empty out current set of buttons.

                currentlyConsideredVideos.forEach((videoObject, index) => {
                    videoObject["pointer"] = index;
                    let $numberedVideoButton = $("<li></li>").data(videoObject);
                    $numberedVideoButton.append(
                        $("<a></a>").text(index + 1)
                    );
                    numberedVideoButtons.push($numberedVideoButton);
                });
                $videoPreviousButton.after(numberedVideoButtons);

                if (currentlyConsideredVideos.length) { // Auto-set first video.
                    $videoSource.attr("src", currentlyConsideredVideos[0]["aws_url"]);
                    numberedVideoButtons[0].addClass("active");
                    $videoElement.load().trigger("play");
                }
            }

            /*
             EVENT LISTENERS
             */
            var $currentlySelectedResponse;  // Lazily initialized closure to maintain previous selected.

            // XXX: Manual event delegation inside
            $pendingJudgementList.on("click", "a.response-option", function (event) {

                // UI Signal - we're paying attention to this video.
                if ($currentlySelectedResponse) { // If we've got something, deselect it.
                    $currentlySelectedResponse.removeClass("active");
                }

                $currentlySelectedResponse = $(this);
                $currentlySelectedResponse.addClass("active");

                let $target = $(event.target);
                let responseData = $currentlySelectedResponse.data();

                // If it's consent or approval, deal with it.
                if ($target.is("button")) {
                    return handleRulingActions($target, $currentlySelectedResponse, responseData);
                } else { // Update the video container with nav buttons.
                    $videoSource.attr("src", "");
                    $videoElement.load();
                    updateVideoContainer($currentlySelectedResponse, responseData["id"]);
                }
            });

            $videoManager.on("click", "li", function(event) {
                let $videoNavButton = $(this),
                    navId = $videoNavButton.attr("id"),
                    length = currentlyConsideredVideos.length,
                    videoData, awsUrl;

                numberedVideoButtons.forEach($button => $button.removeClass("active"));

                if (navId === "nav-video-previous") {
                    currentVideoListIndex -= 1;
                    currentVideoListIndex %= length; // rotate backward
                    videoData = currentlyConsideredVideos[currentVideoListIndex];
                } else if (navId === "nav-video-next") {
                    currentVideoListIndex += 1;
                    currentVideoListIndex %= length; // rotate forward
                    videoData = currentlyConsideredVideos[currentVideoListIndex];
                } else {
                    videoData = $videoNavButton.data(); // Get the actual index from the element.
                    currentVideoListIndex = videoData["pointer"];
                }

                // Mark currently active video
                numberedVideoButtons[currentVideoListIndex].addClass("active");

                awsUrl = videoData["aws_url"];
                $videoSource.attr("src", awsUrl);
                $videoElement.load().trigger("play");
            });
        });
    </script>

{% endblock %}

{% block flash %}
    {% bootstrap_messages %}
    {% if form.non_field_errors %}
        <div class="alert alert-danger" role="alert">
            {{ form.non_field_errors }}
        </div>
    {% endif %}
{% endblock %}

{% block content %}
    <div class='container mb-lg'>
        <div class='row'>
            <div class="col-xs-12">
                <ol class="breadcrumb">
                    <li><a href="{% url 'exp:study-list' %}">Manage Studies</a></li>
                    <li><a href="{% url 'exp:study-detail' pk=study.id %}"> {{ study.name }}</a></li>
                    <li class="active">Consent Manager</li>
                </ol>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12">
                <h1>Consent Manager</h1>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12">
                {% include 'studies/_response_nav_tabs.html' with active="manage-consent" %}
            </div>
        </div>
        <div class="row pt-md">
            <section id="responses-pending-ruling" class="col-md-4 col-xs-12 list-group">
                {% for response in loaded_responses %}
                    <a id="response-option-{{ response.uuid }}"
                       class="response-option list-group-item"
                       data-id="{{ response.uuid }}">
                        <span>{{ response.display_name }}</span>
                        <div class="btn-group-xs pull-right" role="group">
                            <button type="button" value="reset"
                                    class="btn btn-xs btn-default glyphicon glyphicon-remove"></button>
                            <button type="button" value="accepted"
                                    class="btn btn-xs btn-success glyphicon glyphicon-thumbs-up"></button>
                            <button type="button" value="rejected"
                                    class="btn btn-xs btn-danger glyphicon glyphicon-thumbs-down"></button>
                        </div>
                    </a>
                {% endfor %}
            </section>
            <section class="col-md-4 col-xs-12">
                <div class="video-container">
                    <video controls id="video-under-consideration" height="270" width="360">
                        <source src="" type="video/mp4">
                        No playable videos available for this response!
                    </video>
                    <div class="btn-toolbar" id="video-manager">
                        <nav aria-label="Video navigation">
                            <ul class="pagination">
                                <li id="nav-video-previous">
                                    <a aria-label="Previous">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>
                                {# list items go here#}
                                <li id="nav-video-next">
                                    <a aria-label="Next">
                                        <span aria-hidden="true">&raquo;</span>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </section>
            <form id="consent-ruling-form" class="col-md-4 col-xs-12 well" method="POST">{% csrf_token %}
                <ul class="list-group">
                    <li class="list-group-item list-group-item-success">
                        Approvals <span id="approvals-count" class="badge">0</span>
                    </li>
                    <li class="list-group-item list-group-item-danger">
                        Rejections <span id="rejections-count" class="badge">0</span>
                    </li>
                </ul>
                <button type="submit" class="btn btn-primary btn-lg btn-block">Submit Rulings</button>
                <button type="button" class="btn btn-default btn-lg btn-block">Reset Choices</button>
            </form>
        </div>
    </div>
{% endblock %}