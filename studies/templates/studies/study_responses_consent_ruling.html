{% extends 'exp/base.html' %}
{% load bootstrap3 %}
{% load exp_extras %}

{% block title %}Responses | {{ study.name }}{% endblock %}

{% block head %}
    {{ block.super }}
    <script type="application/javascript">
        const RESET = "reset";
        const CONSENT_APPROVAL = "accepted";
        const CONSENT_REJECTION = "rejected";

        $(document).ready(function () {
            /*
             Initialize important elements.
             */
            const $videoElement = $("#video-under-consideration");
            const $pendingJudgementList = $("#consent-videos-pending-ruling");
            const $consentRulingForm = $("#consent-ruling-form");
            const $approvalsCountBadge =  $consentRulingForm.find("#approvals-count");
            const $rejectionsCountBadge =  $consentRulingForm.find("#rejections-count");

            /*
             Helpers.
             */
            function handleRulingActions($button, $consentVideoListItem, videoData) {
                let videoId = videoData["id"],
                    videoRulingHiddenInputId = "video-ruling-" + videoId,
                    hiddenInputAttrs = {id: videoRulingHiddenInputId, type: "hidden"},
                    $hiddenInput = $consentRulingForm.find("#" + videoRulingHiddenInputId);

                // First Manage UI signaling
                switch ($button.val()) {
                    case RESET:
                        $consentVideoListItem.removeClass("list-group-item-danger list-group-item-success");
                        $hiddenInput.remove();
                        return;  // early exit after killing the element.
                    case CONSENT_APPROVAL:
                        $consentVideoListItem.removeClass("list-group-item-danger");
                        $consentVideoListItem.addClass("list-group-item-success");
                        hiddenInputAttrs["name"] = CONSENT_APPROVAL;
                        break;
                    case CONSENT_REJECTION:
                        $consentVideoListItem.removeClass("list-group-item-success");
                        $consentVideoListItem.addClass("list-group-item-danger");
                        hiddenInputAttrs["name"] = CONSENT_REJECTION;
                        break;
                }

                if ($hiddenInput.length) {
                    $hiddenInput.attr("name", hiddenInputAttrs["name"]);
                } else {  // If it's not there, create a new one.
                    hiddenInputAttrs["value"] = videoId;
                    $consentRulingForm.append($("<input/>", hiddenInputAttrs));
                }
            }

            /*
             Set up event listeners.
             */
            var $currentlySelected;  // Lazily initialized closure to maintain previous selected.

            // XXX: Manual event delegation inside
            $pendingJudgementList.on("click", "a.consent-video-option", function(event) {

                // UI Signal - we're paying attention to this video.
                if ($currentlySelected) { // If we've got something, deselect it.
                    $currentlySelected.removeClass("active");
                }

                $currentlySelected = $(this);
                $currentlySelected.addClass("active");

                let $target = $(event.target);
                let videoData = $currentlySelected.data();

                // If it's consent or approval, deal with that first.
                if ($target.is("button")) {
                    return handleRulingActions($target, $currentlySelected, videoData);
                } else { // Populate video data in other place.
                    let awsUrl = videoData["sourceUrl"];
                    $videoElement.attr("src", awsUrl).load();
                    $videoElement.trigger("play");
                }
            });

        });
    </script>

{% endblock %}

{% block flash %}
    {% bootstrap_messages %}
    {% if form.non_field_errors %}
        <div class="alert alert-danger" role="alert">
            {{ form.non_field_errors }}
        </div>
    {% endif %}
{% endblock %}

{% block content %}
    <div class='container mb-lg'>
        <div class='row'>
            <div class="col-xs-12">
                <ol class="breadcrumb">
                    <li><a href="{% url 'exp:study-list' %}">Manage Studies</a></li>
                    <li><a href="{% url 'exp:study-detail' pk=study.id %}"> {{ study.name }}</a></li>
                    <li class="active">Consent Manager</li>
                </ol>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12">
                <h1>Consent Manager</h1>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12">
                {% include 'studies/_response_nav_tabs.html' with active="manage-consent" %}
            </div>
        </div>
        <div class="row pt-md">
            <section id="consent-videos-pending-ruling" class="col-md-4 col-xs-12 list-group">
                {% for video in study.consent_videos %}
                    <a id="list-item-{{ video.uuid }}"
                       class="consent-video-option list-group-item"
                       data-id="{{ video.uuid }}"
                       data-full-name="{{ video.full_name }}"
                       data-created="{{ video.created_at }}"
                       data-source-url="{{ video.download_url }}">

                        <span>{{ video.display_name }}</span>
                        <div class="btn-group-xs pull-right" role="group">
                            <button type="button" value="reset" class="btn btn-xs btn-default glyphicon glyphicon-remove"></button>
                            <button type="button" value="accepted" class="btn btn-xs btn-success glyphicon glyphicon-thumbs-up"></button>
                            <button type="button" value="rejected" class="btn btn-xs btn-danger glyphicon glyphicon-thumbs-down"></button>
                        </div>
                    </a>
                {% endfor %}
            </section>
            <section class="col-md-4 col-xs-12">
                <video controls id="video-under-consideration" height="270" width="360">
                    Please select a video from the left hand column.
                </video>
            </section>
            <form id="consent-ruling-form" class="col-md-4 col-xs-12 well" method="POST">{% csrf_token %}
                <ul class="list-group">
                    <li class="list-group-item list-group-item-success">
                        Approvals <span id="approvals-count" class="badge">0</span>
                    </li>
                    <li class="list-group-item list-group-item-danger">
                        Rejections <span id="rejections-count" class="badge">0</span>
                    </li>
                </ul>
                <button type="submit" class="btn btn-primary btn-lg btn-block">Submit Rulings</button>
                <button type="button" class="btn btn-default btn-lg btn-block">Reset Choices</button>
            </form>
        </div>
    </div>
{% endblock %}