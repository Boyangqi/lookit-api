{% extends 'exp/base.html' %}
{% load bootstrap3 %}
{% load exp_extras %}

{% block title %}Responses | {{ study.name }}{% endblock %}

{% block head %}
    {{ block.super }}
    <script type="application/json" id="response-video-map">
        {#    #}
        {{ response_video_map | safe }}
    </script>
    <script type="application/javascript">
        const RESET = "reset",
              CONSENT_APPROVAL = "accepted",
              CONSENT_REJECTION = "rejected",
              RESPONSE_VIDEO_MAP = JSON.parse(document.querySelector("#response-video-map").innerText),
              COMMENTS_CACHE = {};

        $(document).ready(function () {
            /*
             Initialize important elements. $-prepended elements indicate jQuery element.
             */
            // Element Members.
            const $videoElement = $("#video-under-consideration"),
                  $videoSource = $videoElement.find("source"),
                  $videoManager = $("#video-manager"),
                  $videoPreviousButton = $videoManager.find("#nav-video-previous"),
                  $videoNextButton = $videoManager.find("#nav-video-next"),
                  $responseComments = $("#response-commentary"),
                  $pendingJudgementList = $("#responses-pending-ruling"),
                  $consentRulingForm = $("#consent-ruling-form"),
                  $approvalsCountBadge = $consentRulingForm.find("#approvals-count"),
                  $rejectionsCountBadge = $consentRulingForm.find("#rejections-count"),
                  $commentsHiddenInput = $consentRulingForm.find("input[name='comments']");

            // Lazily initialized closures (mutable members).
            var currentlyConsideredVideos,
                currentVideoListIndex,
                numberedVideoButtons,
                $currentlySelectedResponse; // jQuery container for response li.

            /*
             "Controller methods" - using closures to mimic class-like behavior.
             */
            function updateBadges() {
                $approvalsCountBadge.text($(`.consent-ruling[name=${CONSENT_APPROVAL}]`).length);
                $rejectionsCountBadge.text($(`.consent-ruling[name=${CONSENT_REJECTION}]`).length);
            }

            function saveComments() {
                let currentText = $responseComments.val();
                if (currentText) {
                    COMMENTS_CACHE[$currentlySelectedResponse.data("id")] = $responseComments.val();
                }
            }

            function retrieveComments() {
                $responseComments.val(COMMENTS_CACHE[$currentlySelectedResponse.data("id")] || "");
            }

            function handleRulingActions($button, $responseListItem, responseData) {
                let responseId = responseData["id"],
                    responseRulingHiddenInputId = "consent-ruling-" + responseId,
                    hiddenInputAttrs = {id: responseRulingHiddenInputId, type: "hidden"},
                    $hiddenInput = $consentRulingForm.find("#" + responseRulingHiddenInputId);

                // First, change the UI signaling in the pending list.
                switch ($button.val()) {
                    case RESET:
                        $responseListItem.removeClass("list-group-item-danger list-group-item-success");
                        $hiddenInput.remove();
                        updateBadges();
                        return;  // early exit after killing the element, which is why we need to update badges here.
                    case CONSENT_APPROVAL:
                        $responseListItem.removeClass("list-group-item-danger");
                        $responseListItem.addClass("list-group-item-success");
                        hiddenInputAttrs["name"] = CONSENT_APPROVAL;
                        break;
                    case CONSENT_REJECTION:
                        $responseListItem.removeClass("list-group-item-success");
                        $responseListItem.addClass("list-group-item-danger");
                        hiddenInputAttrs["name"] = CONSENT_REJECTION;
                        break;
                }

                // Now, either change or add the hidden form input.
                if ($hiddenInput.length) {
                    $hiddenInput.attr("name", hiddenInputAttrs["name"]);
                } else {  // If it's not there, create a new one...
                    hiddenInputAttrs["value"] = responseId;
                    $consentRulingForm.append($("<input/>", hiddenInputAttrs).addClass("consent-ruling"));
                }

                // ... Finally, update the UI with whatever approval state was changed.
                updateBadges();
            }


            function updateVideoContainer($selectedResponseItem, responseId) {
                // 1) Clear the current container
                $videoSource.attr("src", "");
                $videoElement.load();
                $videoPreviousButton.nextUntil($videoNextButton).remove();

                currentlyConsideredVideos = RESPONSE_VIDEO_MAP[responseId];
                currentVideoListIndex = 0;

                numberedVideoButtons = []; // Empty out current set of buttons.

                currentlyConsideredVideos.forEach((videoObject, index) => {
                    videoObject["pointer"] = index;
                    let $numberedVideoButton = $("<li></li>").data(videoObject);
                    $numberedVideoButton.append(
                        $("<a></a>").text(index + 1)
                    );
                    numberedVideoButtons.push($numberedVideoButton);
                });
                $videoPreviousButton.after(numberedVideoButtons);

                if (currentlyConsideredVideos.length) { // Auto-set first video.
                    $videoSource.attr("src", currentlyConsideredVideos[0]["aws_url"]);
                    numberedVideoButtons[0].addClass("active");
                    $videoElement.load().trigger("play");
                }
            }

            /*
             EVENT LISTENERS.
             XXX: Lots of manual event delegation inside, to account for constantly-updating elements.
             */
            $pendingJudgementList.on("click", "a.response-option", function (event) {

                // UI Signal - we're paying attention to this video.
                if ($currentlySelectedResponse) { // If we've got something, deselect it.
                    $currentlySelectedResponse.removeClass("active");
                    saveComments();
                }

                $currentlySelectedResponse = $(this);
                retrieveComments();
                $currentlySelectedResponse.addClass("active");

                let $target = $(event.target);
                let responseData = $currentlySelectedResponse.data();

                // If it's consent or approval, deal with it.
                if ($target.is("button")) {
                    handleRulingActions($target, $currentlySelectedResponse, responseData);
                } else { // Update the video container with nav buttons.
                    updateVideoContainer($currentlySelectedResponse, responseData["id"]);
                }
            });

            $videoManager.on("click", "li", function(event) {
                let $videoNavButton = $(this),
                    navId = $videoNavButton.attr("id"),
                    length = currentlyConsideredVideos.length,
                    videoData, awsUrl;

                numberedVideoButtons.forEach($button => $button.removeClass("active"));

                if (navId === "nav-video-previous") {
                    currentVideoListIndex -= 1;
                    currentVideoListIndex %= length; // rotate backward,
                    videoData = currentlyConsideredVideos[currentVideoListIndex];
                } else if (navId === "nav-video-next") {
                    currentVideoListIndex += 1;
                    currentVideoListIndex %= length; // rotate forward,
                    videoData = currentlyConsideredVideos[currentVideoListIndex];
                } else {
                    videoData = $videoNavButton.data(); // or the actual index from the element data.
                    currentVideoListIndex = videoData["pointer"];
                }

                // Mark currently active video.
                numberedVideoButtons[currentVideoListIndex].addClass("active");

                awsUrl = videoData["aws_url"];
                $videoSource.attr("src", awsUrl);
                $videoElement.load().trigger("play");
            });

            $consentRulingForm.submit(function(event) {
                // Create comments JSON and append to form.
                saveComments();
                $commentsHiddenInput.val(JSON.stringify(COMMENTS_CACHE));
            });
        });
    </script>

{% endblock %}

{% block flash %}
    {% bootstrap_messages %}
    {% if form.non_field_errors %}
        <div class="alert alert-danger" role="alert">
            {{ form.non_field_errors }}
        </div>
    {% endif %}
{% endblock %}

{% block content %}
    <div class='container mb-lg'>
        <div class='row'>
            <div class="col-xs-12">
                <ol class="breadcrumb">
                    <li><a href="{% url 'exp:study-list' %}">Manage Studies</a></li>
                    <li><a href="{% url 'exp:study-detail' pk=study.id %}"> {{ study.name }}</a></li>
                    <li class="active">Consent Manager</li>
                </ol>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12">
                <h1>Consent Manager</h1>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12">
                {% include 'studies/_response_nav_tabs.html' with active="manage-consent" %}
            </div>
        </div>
        <div class="row pt-md">
            <section id="responses-pending-ruling" class="col-md-4 col-xs-12 list-group">
                {% for response in loaded_responses %}
                    <a id="response-option-{{ response.uuid }}"
                       class="response-option list-group-item"
                       data-id="{{ response.uuid }}">
                        <span>{{ response.display_name }}</span>
                        <div class="btn-group-xs pull-right" role="group">
                            <button type="button" value="reset"
                                    class="btn btn-xs btn-default glyphicon glyphicon-remove"></button>
                            <button type="button" value="accepted"
                                    class="btn btn-xs btn-success glyphicon glyphicon-thumbs-up"></button>
                            <button type="button" value="rejected"
                                    class="btn btn-xs btn-danger glyphicon glyphicon-thumbs-down"></button>
                        </div>
                    </a>
                {% endfor %}
            </section>
            <section class="col-md-4 col-xs-12">
                <div class="video-container">
                    <video controls id="video-under-consideration" height="270" width="360">
                        <source src="" type="video/mp4">
                    </video>
                    <textarea id="response-commentary"
                              class="form-control"
                              placeholder="Comment on session. These will be saved upon submit."></textarea>
                    <div class="btn-toolbar" id="video-manager">
                        <nav aria-label="Video navigation">
                            <ul class="pagination">
                                <li id="nav-video-previous">
                                    <a aria-label="Previous">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>
                                {# list items go here#}
                                <li id="nav-video-next">
                                    <a aria-label="Next">
                                        <span aria-hidden="true">&raquo;</span>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </section>
            <form id="consent-ruling-form" class="col-md-4 col-xs-12 well" method="POST">{% csrf_token %}
                <ul class="list-group">
                    <li class="list-group-item list-group-item-success">
                        Approvals <span id="approvals-count" class="badge">0</span>
                    </li>
                    <li class="list-group-item list-group-item-danger">
                        Rejections <span id="rejections-count" class="badge">0</span>
                    </li>
                </ul>
                <input name="comments" type="hidden" value="{}"/>
                <button type="submit" class="btn btn-primary btn-lg btn-block">Submit Rulings</button>
                <button type="button" class="btn btn-default btn-lg btn-block">Reset Choices</button>
            </form>
        </div>
    </div>
{% endblock %}